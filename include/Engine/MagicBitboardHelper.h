#pragma once

#include <array>
#include <iostream>
#include <random>
#include <vector>

#include "BoardRepresentation/Bitboard.h"
#include "BoardRepresentation/Square.h"


constexpr Bitboard FILE_A { 0x8080808080808080 };
constexpr Bitboard FILE_B { 0x4040404040404040 };
constexpr Bitboard FILE_C { 0x2020202020202020 };
constexpr Bitboard FILE_D { 0x1010101010101010 };
constexpr Bitboard FILE_E { 0x0808080808080808 };
constexpr Bitboard FILE_F { 0x0404040404040404 };
constexpr Bitboard FILE_G { 0x0202020202020202 };
constexpr Bitboard FILE_H { 0x0101010101010101 };

constexpr Bitboard RANK_1 { 0x00000000000000FF };
constexpr Bitboard RANK_2 { 0x000000000000FF00 };
constexpr Bitboard RANK_3 { 0x0000000000FF0000 };
constexpr Bitboard RANK_4 { 0x00000000FF000000 };
constexpr Bitboard RANK_5 { 0x000000FF00000000 };
constexpr Bitboard RANK_6 { 0x0000FF0000000000 };
constexpr Bitboard RANK_7 { 0x00FF000000000000 };
constexpr Bitboard RANK_8 { 0xFF00000000000000 };

constexpr Bitboard EMPTY_BOARD { 0ULL };
constexpr Bitboard FULL_BOARD { ~EMPTY_BOARD };
constexpr Bitboard INNER_BOARD { FULL_BOARD & ~FILE_A & ~FILE_H & ~RANK_1 & ~RANK_8 };

// Orthogonal stuff

#define MAX_ORTHOGONAL_RELEVANT_BITS 12
#define ORTHOGONAL_SHIFT (64 - MAX_ORTHOGONAL_RELEVANT_BITS)
#define ORTHOGONAL_CONFIGURATIONS (1 << MAX_ORTHOGONAL_RELEVANT_BITS)

constexpr std::array<Bitboard, 8> FILES = { FILE_A, FILE_B, FILE_C, FILE_D, FILE_E, FILE_F, FILE_G, FILE_H };
constexpr std::array<Bitboard, 8> RANKS = { RANK_1, RANK_2, RANK_3, RANK_4, RANK_5, RANK_6, RANK_7, RANK_8 };

constexpr std::array<Bitboard, static_cast<size_t>(Square::COUNT)> ORTHOGONAL_RAYS {
	72340172838076926ULL, 144680345676153597ULL, 289360691352306939ULL, 578721382704613623ULL, 1157442765409226991ULL, 2314885530818453727ULL, 4629771061636907199ULL, 9259542123273814143ULL, 72340172838141441ULL, 144680345676217602ULL, 289360691352369924ULL, 578721382704674568ULL, 1157442765409283856ULL, 2314885530818502432ULL, 4629771061636939584ULL, 9259542123273813888ULL, 72340172854657281ULL, 144680345692602882ULL, 289360691368494084ULL, 578721382720276488ULL, 1157442765423841296ULL, 2314885530830970912ULL, 4629771061645230144ULL, 9259542123273748608ULL, 72340177082712321ULL, 144680349887234562ULL, 289360695496279044ULL, 578721386714368008ULL, 1157442769150545936ULL, 2314885534022901792ULL, 4629771063767613504ULL, 9259542123257036928ULL, 72341259464802561ULL, 144681423712944642ULL, 289361752209228804ULL, 578722409201797128ULL, 1157443723186933776ULL, 2314886351157207072ULL, 4629771607097753664ULL, 9259542118978846848ULL, 72618349279904001ULL, 144956323094725122ULL, 289632270724367364ULL, 578984165983651848ULL, 1157687956502220816ULL, 2315095537539358752ULL, 4629910699613634624ULL, 9259541023762186368ULL, 143553341945872641ULL, 215330564830528002ULL, 358885010599838724ULL, 645993902138460168ULL, 1220211685215703056ULL, 2368647251370188832ULL, 4665518383679160384ULL, 9259260648297103488ULL, 18302911464433844481ULL, 18231136449196065282ULL, 18087586418720506884ULL, 17800486357769390088ULL, 17226286235867156496ULL, 16077885992062689312ULL, 13781085504453754944ULL, 9187484529235886208ULL
};

constexpr size_t GetRank(Square square) {
	return static_cast<int>(square) / 8;
}

constexpr size_t GetFile(Square square) {
	return 7 - (static_cast<int>(square) % 8);
}

constexpr Bitboard GenerateOrthogonalOccupancyMask(Square square) {
	size_t rank = GetRank(square);
	size_t file = GetFile(square);

	Bitboard occupancyMask = RANKS[rank] | FILES[file];

	if (rank != 0) occupancyMask &= ~RANKS[0];

	if (rank != 7) occupancyMask &= ~RANKS[7];

	if (file != 0) occupancyMask &= ~FILES[0];

	if (file != 7) occupancyMask &= ~FILES[7];

	occupancyMask &= ~Bitboard(square);

	return occupancyMask;
}

constexpr std::array<Bitboard, static_cast<size_t>(Square::COUNT)> ORTHOGONAL_OCCUPANCY_MASKS {
	#define X(square) GenerateOrthogonalOccupancyMask(Square::square),
	SQUARE_LIST
	#undef X
};

constexpr Bitboard GetOrthogonalOccupancyMask(Square square) {
	return ORTHOGONAL_OCCUPANCY_MASKS[static_cast<size_t>(square)];
}

constexpr std::array<uint64_t, static_cast<size_t>(Square::COUNT)> ORTHOGONAL_MAGICS {
	9403516606337777698ULL, 9259436022746316928ULL, 9296555552813350976ULL, 580964455010144336ULL, 72066390281965643ULL, 1585284807049447429ULL, 9369741224036061192ULL, 360288521021689088ULL, 4612864696301682688ULL, 869339865770166080ULL, 4611729999433568312ULL, 2884608342553010320ULL, 9079767192076293ULL, 36100270108836352ULL, 18054066844602434ULL, 72339176389175750ULL, 9277468558701364512ULL, 19292048209322000ULL, 9009432656093256ULL, 1157568246904782976ULL, 81073727361777714ULL, 2378226196678443009ULL, 145346710088977204ULL, 35218734579776ULL, 9229054313098413121ULL, 9315731013656117504ULL, 2454501586836652544ULL, 3382106390790160ULL, 2537811383157264ULL, 613615502379486500ULL, 720611416809181192ULL, 2205465978949ULL, 18049588271255552ULL, 379437064970602754ULL, 9557764343548870690ULL, 144255934221324354ULL, 432504186362462336ULL, 18309067945017856ULL, 297522632386414616ULL, 2738751798817853696ULL, 291680094420731904ULL, 73183666012162048ULL, 9226896109061047296ULL, 4899920828060270594ULL, 4904446524287096834ULL, 6917533425696246306ULL, 4630087453636591712ULL, 594615889375076356ULL, 17729637580864ULL, 45044929809896512ULL, 11565459416096440452ULL, 35461398528200ULL, 1152930303652921476ULL, 432665041477632512ULL, 9223671112615854184ULL, 126101906803393024ULL, 1297318513404813889ULL, 114486832924690ULL, 585490011047069761ULL, 4755803817911649474ULL, 149533732372997ULL, 586031348456882306ULL, 143520895729956ULL, 13835903047164903714ULL
};

// Diagonal stuff
#define MAX_DIAGONAL_RELEVANT_BITS 11
#define DIAGONAL_SHIFT (64 - MAX_DIAGONAL_RELEVANT_BITS)
#define DIAGONAL_CONFIGURATIONS (1 << MAX_DIAGONAL_RELEVANT_BITS)

constexpr std::array<Bitboard, static_cast<size_t>(Square::COUNT)> DIAGONAL_RAYS {
	9241421688590303744ULL, 36099303471056128ULL, 141012904249856ULL, 550848566272ULL, 6480472064ULL, 1108177604608ULL, 283691315142656ULL, 72624976668147712ULL, 4620710844295151618ULL, 9241421688590368773ULL, 36099303487963146ULL, 141017232965652ULL, 1659000848424ULL, 283693466779728ULL, 72624976676520096ULL, 145249953336262720ULL, 2310355422147510788ULL, 4620710844311799048ULL, 9241421692918565393ULL, 36100411639206946ULL, 424704217196612ULL, 72625527495610504ULL, 145249955479592976ULL, 290499906664153120ULL, 1155177711057110024ULL, 2310355426409252880ULL, 4620711952330133792ULL, 9241705379636978241ULL, 108724279602332802ULL, 145390965166737412ULL, 290500455356698632ULL, 580999811184992272ULL, 577588851267340304ULL, 1155178802063085600ULL, 2310639079102947392ULL, 4693335752243822976ULL, 9386671504487645697ULL, 326598935265674242ULL, 581140276476643332ULL, 1161999073681608712ULL, 288793334762704928ULL, 577868148797087808ULL, 1227793891648880768ULL, 2455587783297826816ULL, 4911175566595588352ULL, 9822351133174399489ULL, 1197958188344280066ULL, 2323857683139004420ULL, 144117404414255168ULL, 360293502378066048ULL, 720587009051099136ULL, 1441174018118909952ULL, 2882348036221108224ULL, 5764696068147249408ULL, 11529391036782871041ULL, 4611756524879479810ULL, 567382630219904ULL, 1416240237150208ULL, 2833579985862656ULL, 5667164249915392ULL, 11334324221640704ULL, 22667548931719168ULL, 45053622886727936ULL, 18049651735527937ULL
};

constexpr Bitboard GenerateDiagonalOccupancyMask(Square square) {
	Bitboard bb = Bitboard(square);

	Bitboard occupancyMask{0ULL};

	Bitboard shadow;

	shadow = bb;
	while (shadow.Any()) {
		shadow = shadow.ShiftNorthEast();
		occupancyMask |= shadow;
	}

	shadow = bb;
	while (shadow.Any()) {
		shadow = shadow.ShiftSouthEast();
		occupancyMask |= shadow;
	}

	shadow = bb;
	while (shadow.Any()) {
		shadow = shadow.ShiftSouthWest();
		occupancyMask |= shadow;
	}

	shadow = bb;
	while (shadow.Any()) {
		shadow = shadow.ShiftNorthWest();
		occupancyMask |= shadow;
	}

	occupancyMask &= INNER_BOARD;

	return occupancyMask;
}

constexpr std::array<Bitboard, static_cast<size_t>(Square::COUNT)> DIAGONAL_OCCUPANCY_MASKS {
	18049651735527936, 70506452091904, 275415828992, 1075975168, 38021120, 8657588224, 2216338399232, 567382630219776, 9024825867763712, 18049651735527424, 70506452221952, 275449643008, 9733406720, 2216342585344, 567382630203392, 1134765260406784, 4512412933816832, 9024825867633664, 18049651768822272, 70515108615168, 2491752130560, 567383701868544, 1134765256220672, 2269530512441344, 2256206450263040, 4512412900526080, 9024834391117824, 18051867805491712, 637888545440768, 1135039602493440, 2269529440784384, 4539058881568768, 1128098963916800, 2256197927833600, 4514594912477184, 9592139778506752, 19184279556981248, 2339762086609920, 4538784537380864, 9077569074761728, 562958610993152, 1125917221986304, 2814792987328512, 5629586008178688, 11259172008099840, 22518341868716544, 9007336962655232, 18014673925310464, 2216338399232, 4432676798464, 11064376819712, 22137335185408, 44272556441600, 87995357200384, 35253226045952, 70506452091904, 567382630219776, 1134765260406784, 2832480465846272, 5667157807464448, 11333774449049600, 22526811443298304, 9024825867763712, 18049651735527936
};

constexpr std::array<uint64_t, static_cast<size_t>(Square::COUNT)> DIAGONAL_MAGICS {
	3386515187041792ULL, 143091139870848ULL, 5422615572369113088ULL, 4323784413709074432ULL, 567356615036928ULL, 3620911770454983220ULL, 324567586586239008ULL, 5188709755388203520ULL, 1152928239116157956ULL, 1770143906043822720ULL, 4613942363398865024ULL, 9019433418754ULL, 9556726388768113152ULL, 36028805715099651ULL, 18061283178841088ULL, 2386908389043087402ULL, 432363225687802096ULL, 562985127003977ULL, 18034498960885888ULL, 9009989106532864ULL, 105556069134419ULL, 9024791620096000ULL, 1143492638150656ULL, 2306010170565595136ULL, 1752463548866628608ULL, 59379000804352ULL, 292805455053848584ULL, 4521741838721026ULL, 1013450723442475009ULL, 5764651516392637440ULL, 93487084253282885ULL, 1161643174134784ULL, 36319070538174464ULL, 17609370240064ULL, 2305846892401131792ULL, 387595033379840ULL, 157907669166854148ULL, 292755966078748752ULL, 36899628498551296ULL, 108315099676606592ULL, 38298191199740931ULL, 1236264554778888192ULL, 144133884085305984ULL, 1441433360047013896ULL, 306825592886804512ULL, 597294350526840873ULL, 362544729618120720ULL, 4612882296415223874ULL, 2382474605988153344ULL, 189292094714680320ULL, 94865897738613313ULL, 594501573657493568ULL, 18313474265323552ULL, 10088204182038258048ULL, 18023195676379714ULL, 2315171270293995569ULL, 11538294263964500104ULL, 4611690554181420080ULL, 4611985094180360448ULL, 292839528929312800ULL, 18858866397217028ULL, 4648561714293427234ULL, 7007601329428758656ULL, 10396841352536019008ULL
};

constexpr Bitboard GetDiagonalOccupancyMask(Square square) {
	return DIAGONAL_OCCUPANCY_MASKS[static_cast<size_t>(square)];
}

// Knight stuff
constexpr std::array<Bitboard, static_cast<size_t>(Square::COUNT)> KNIGHT_ATTACK_SETS {
	132096ULL, 329728ULL, 659712ULL, 1319424ULL, 2638848ULL, 5277696ULL, 10489856ULL, 4202496ULL, 33816580ULL, 84410376ULL, 168886289ULL, 337772578ULL, 675545156ULL, 1351090312ULL, 2685403152ULL, 1075839008ULL, 8657044482ULL, 21609056261ULL, 43234889994ULL, 86469779988ULL, 172939559976ULL, 345879119952ULL, 687463207072ULL, 275414786112ULL, 2216203387392ULL, 5531918402816ULL, 11068131838464ULL, 22136263676928ULL, 44272527353856ULL, 88545054707712ULL, 175990581010432ULL, 70506185244672ULL, 567348067172352ULL, 1416171111120896ULL, 2833441750646784ULL, 5666883501293568ULL, 11333767002587136ULL, 22667534005174272ULL, 45053588738670592ULL, 18049583422636032ULL, 145241105196122112ULL, 362539804446949376ULL, 725361088165576704ULL, 1450722176331153408ULL, 2901444352662306816ULL, 5802888705324613632ULL, 11533718717099671552ULL, 4620693356194824192ULL, 288234782788157440ULL, 576469569871282176ULL, 1224997833292120064ULL, 2449995666584240128ULL, 4899991333168480256ULL, 9799982666336960512ULL, 1152939783987658752ULL, 2305878468463689728ULL, 1128098930098176ULL, 2257297371824128ULL, 4796069720358912ULL, 9592139440717824ULL, 19184278881435648ULL, 38368557762871296ULL, 4679521487814656ULL, 9077567998918656ULL
};

// King stuff
constexpr std::array<Bitboard, static_cast<size_t>(Square::COUNT)> KING_ATTACK_SETS {
	770ULL, 1797ULL, 3594ULL, 7188ULL, 14376ULL, 28752ULL, 57504ULL, 49216ULL, 197123ULL, 460039ULL, 920078ULL, 1840156ULL, 3680312ULL, 7360624ULL, 14721248ULL, 12599488ULL, 50463488ULL, 117769984ULL, 235539968ULL, 471079936ULL, 942159872ULL, 1884319744ULL, 3768639488ULL, 3225468928ULL, 12918652928ULL, 30149115904ULL, 60298231808ULL, 120596463616ULL, 241192927232ULL, 482385854464ULL, 964771708928ULL, 825720045568ULL, 3307175149568ULL, 7718173671424ULL, 15436347342848ULL, 30872694685696ULL, 61745389371392ULL, 123490778742784ULL, 246981557485568ULL, 211384331665408ULL, 846636838289408ULL, 1975852459884544ULL, 3951704919769088ULL, 7903409839538176ULL, 15806819679076352ULL, 31613639358152704ULL, 63227278716305408ULL, 54114388906344448ULL, 216739030602088448ULL, 505818229730443264ULL, 1011636459460886528ULL, 2023272918921773056ULL, 4046545837843546112ULL, 8093091675687092224ULL, 16186183351374184448ULL, 13853283560024178688ULL, 144959613005987840ULL, 362258295026614272ULL, 724516590053228544ULL, 1449033180106457088ULL, 2898066360212914176ULL, 5796132720425828352ULL, 11592265440851656704ULL, 4665729213955833856ULL
};


class MagicBitboardHelper {
public:
	MagicBitboardHelper();

	inline Bitboard GetOrthogonalAttacks(Square square, Bitboard configuration) const { return m_orthogonalAttacks[static_cast<size_t>(square)][GetOrthogonalIndex(square, configuration)]; }
	inline Bitboard GetDiagonalAttacks(Square square, Bitboard configuration) const { return m_diagonalAttacks[static_cast<size_t>(square)][GetDiagonalIndex(square, configuration)]; }
	inline Bitboard GetKnightAttacks(Square square) const { return KNIGHT_ATTACK_SETS[static_cast<size_t>(square)]; }
	inline Bitboard GetKingAttacks(Square square) const { return KING_ATTACK_SETS[static_cast<size_t>(square)]; }

	inline Bitboard GetBetweenMask(Square square1, Square square2) { return m_betweenMasks[static_cast<size_t>(square1)][static_cast<size_t>(square2)]; }

private:
	inline uint64_t GenerateMagic() { return m_rng() & m_rng() & m_rng(); }

	void PopulateBetweenMasks(Square square);
	void PopulateBetweenMasks();

	// Orthogonal stuff

	inline size_t GetOrthogonalIndex(Square square, Bitboard occupancy) const {
		size_t magic = ORTHOGONAL_MAGICS[static_cast<size_t>(square)];
		return (occupancy * magic) >> ORTHOGONAL_SHIFT;
	}

	void GenerateOrthogonalRays(Square square);
	void GenerateOrthogonalRays();
	
	Bitboard GenerateOrthogonalAttacks(Square square, Bitboard occupancy);
	void GenerateOrthogonalOccupanciesAndAttacks(Square square, std::vector<Bitboard>& occupancies, std::vector<Bitboard>& attackSets);

	uint64_t SearchForOrthogonalMagic(const std::vector<Bitboard>& occupancies, const std::vector<Bitboard>& attackSets);
	void GenerateOrthogonalMagic(Square square);
	void GenerateOrthogonalMagics();

	void PopulateOrthogonalAttacks(Square square);
	void PopulateOrthogonalAttacks();


	// Diagonal stuff

	inline size_t GetDiagonalIndex(Square square, Bitboard occupancy) const {
		size_t magic = DIAGONAL_MAGICS[static_cast<size_t>(square)];
		return (occupancy * magic) >> DIAGONAL_SHIFT;
	}

	void GenerateDiagonalRays(Square square);
	void GenerateDiagonalRays();

	Bitboard GenerateDiagonalAttacks(Square square, Bitboard occupancy);
	void GenerateDiagonalOccupanciesAndAttacks(Square square, std::vector<Bitboard>& occupancies, std::vector<Bitboard>& attackSets);

	uint64_t SearchForDiagonalMagic(const std::vector<Bitboard>& occupancies, const std::vector<Bitboard>& attackSets);
	void GenerateDiagonalMagic(Square square);
	void GenerateDiagonalMagics();

	void PopulateDiagonalAttacks(Square square);
	void PopulateDiagonalAttacks();

	// Knight stuff
	void GenerateKnightAttacks(Square square);
	void GenerateKnightAttacks();

	//King stuff
	void GenerateKingAttacks(Square square);
	void GenerateKingAttacks();

	std::mt19937_64 m_rng;

	std::array<std::array<Bitboard, ORTHOGONAL_CONFIGURATIONS>, static_cast<size_t>(Square::COUNT)> m_orthogonalAttacks;
	std::array<std::array<Bitboard, DIAGONAL_CONFIGURATIONS>, static_cast<size_t>(Square::COUNT)> m_diagonalAttacks;

	std::array<std::array<Bitboard, static_cast<size_t>(Square::COUNT)>, static_cast<size_t>(Square::COUNT)> m_betweenMasks;
};